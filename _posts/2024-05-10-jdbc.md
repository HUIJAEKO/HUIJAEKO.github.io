---
layout: single
title: "인프런 스프링 입문(jdbc와 jpa)"
categories: spring
---

#### `이 포스트는 인프런 김영한님의 강의 및 자료를 사용합니다`

이번 강의는 기존에 회원가입을 했을 때 메모리에 저장했던 것을, 데이터베이스를 이용하여 데이터베이스에 저장할 수 있도록 하는 강의이다. 

먼저, spring에서 데이터베이스를 이용하기 위해서는 `gradle`파일과 `properties`파일에 라이브러리와 설정을 추가해주어야한다.

예를 들어, 강의에서는 h2 데이터베이스를 이용하기 때문에 아래와 같이 설정한다.

다른 데이터베이스를 사용하면 그에 따른 설정을 추가해주면 된다.

**build.gradle**

```
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
runtimeOnly 'com.h2database:h2'
```

**resources/application.properties**

```
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
```


## jdbc 리포지토리 구현

아래는 jdbc api로 직접 코딩을 한 것의 일부분이다. 아주 옛날에 사용했던 것이기 때문에 딥하게 공부하는 것보다는 이런게 있었구나라는 생각으로 강의자료에 있는 것을 한번씩 보면 될 것 같다. 

중요한 것은, 아래와 같이 `JdbcMemberRepository`의 코드를 짜면 h2 DB에 결과가 잘 입력되게 된다.

따라서 기존에 메모리에 저장을 했을 때 재실행을 데이터가 사라지는 것과는 달리 재실행을 해도 데이터가 저장되어 있는 것을 확인할 수 있다.

```java
public class JdbcMemberRepository implements MemberRepository {
  private final DataSource dataSource;
  public JdbcMemberRepository(DataSource dataSource) {
    this.dataSource = dataSource;
  }
  @Override
  public Member save(Member member) {
    String sql = "insert into member(name) values(?)";
    Connection conn = null;
    PreparedStatement pstmt = null;
    ResultSet rs = null;
    try {
      conn = getConnection();
      pstmt = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
      pstmt.setString(1, member.getName());
      pstmt.executeUpdate();
      rs = pstmt.getGeneratedKeys();
      if (rs.next()) {
        member.setId(rs.getLong(1));
      } else {
        throw new SQLException("id 조회 실패");
      }
      return member;
    } catch (Exception e) {
      throw new IllegalStateException(e);
    } finally {
      close(conn, pstmt, rs);
    }
  }
  @Override
  public Optional<Member> findById(Long id){
    .........
  }
.
.
.
.
 ```

이 코드를 사용하기 위해서는 또 한가지 설정을 해주어야 한다.

기존에 `MemberRepository`를 스프링 빈으로 등록을 할 때는 아래와 같이 등록을 하였다.

```java
@Bean
public MemberRepository memberRepository() {
  return new MemoryMemberRepository();
}
```

하지만, 이제는 새로 만든 `JdbcMemberRepository`를 사용하기 때문에 코드를 수정해준다.

```java
@Bean
public MemberRepository memberRepository() {
  return new JdbcMemberRepository(dataSource);
}
```

