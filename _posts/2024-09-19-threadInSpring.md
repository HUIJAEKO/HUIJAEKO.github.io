---
layout: single
title: "백엔드 개발에서 중요한 쓰레드 사용법"
categories: spring
---

#### `이 포스트는 인프런 김영한님의 강의 및 자료를 사용합니다`

## 쓰레드란 무엇일까?

1. 애플리케이션 코드를 하나하나 순차적으로 실행하는 것은 쓰레드이다.
2. 자바 메인 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행된다.
3. 쓰레드가 없다면 자바 애플리케이션 실행이 불가능하다.
4. 쓰레드는 한번에 하나의 코드 라인만 수행한다.
5. 동시 처리가 필요하면 쓰레드를 추가로 생성한다.

### 그렇다면 어떻게 쓰레드가 실행되는지 알아보자.

먼저, 요청이 하나하나 순차적으로 들어온다고 가정하자. 

그렇다면 아래 사진과 같이 들어온 요청에 쓰레드가 할당되어 요청을 처리할 것이다.

요청을 처리한 뒤에는 쓰레드 휴식상태가 되고, 다시 요청을 하면 쓰레드가 할당이 될 것이다.

![Thread](/images/Thread.png)

### 하지만 요청이 여러개가 오게 된다면?

요청1과 요청2가 있다고 했을때, 요청1을 처리하는 도중에 요청2가 들어왔다고 생각해보자.

그렇다면 결국 요청1의 처리는 지연될 것이고, 결국 요청1과 요청2는 모두 처리를 실패할 것이다.

![Thread2](/images/Thread2.png)

### 그렇다면 쓰레드를 여러개 사용하면 되지 않을까?

물론 요청이 들어올 때마다 쓰레드를 생성하여 사용해도 괜찮다.

하지만, 이러한 방법에는 여러 장점과 단점이 존재한다.

**장점**
- 동시 요청을 처리할 수 있다.
- 리소스(CPU, 메모리)가 허용할 때 까지 처리가능하다.
- 하나의 쓰레드가 지연 되어도, 나머지 쓰레드는 정상 동작한다.

**단점**
- 쓰레드 생성 비용은 매우 비싸다.
- 고객의 요청이 올 때 마다 쓰레드를 생성하면, 응답 속도가 늦어진다.
- 쓰레드는 컨텍스트 스위칭 비용이 발생한다.
- 쓰레드 생성에 제한이 없다.
- 고객 요청이 너무 많이 오면, CPU, 메모리 임계점을 넘어서 서버가 죽을 수 있다.

### 결국, 쓰레드풀을 사용하는 것이 최고의 방법이다!

쓰레드풀을 사용한다는 것은, 필요한 쓰레드를 쓰레드 풀에 보관하고 관리하는 것을 의미한다.

쓰레드가 필요하면, 이미 생성되어 있는 쓰레드를 쓰레드 풀에서 꺼내서 사용한다.

그리고 사용을 종료하면 쓰레드 풀에 해당 쓰레드를 반납한다.

![Threadful](/images/Threadful.png)

하지만 최대 쓰레드가 모두 사용중이어서 쓰레드 풀에 쓰레드가 없으면?

기다리는 요청은 거절하거나 특정 숫자만큼만 대기하도록 설정할 수 있다.

![Threadful2](/images/Threadful2.png)

### 쓰레드풀의 장점
- 쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용(CPU)이 절약되고, 응답 시간이 빠르다.
- 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다.

### 쓰레드풀을 사용할 때 가장 중요한 것은 최대 쓰레드 수이다.
- 너무 낮게 설정을 하게될 경우, 동시 요청이 많으면, 서버 리소스는 여유롭지만 클라이언트는 금방 응답이 지연된다.
- 너무 높게 설정을 하게될 경우, 동시 요청이 많으면, CPU, 메모리 리소스 임계점 초과로 서버가 다운된다.


